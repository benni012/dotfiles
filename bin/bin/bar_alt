#!/bin/sh

cf="%{F$(xrq *color8)}"
# cb="%{B$(xrq *color5)}"
ef="%{F-}"
# eb="%{B-}"

clock() {
	date "+%d.%m.%Y %H:%M:%S"
}

tea() {
	if [ $(pgrep -x tt | wc -l) -ge 1 -o $(atq | wc -l) -ge 1 ]; then
		echo "%{F$(xrq *color14)}"
	else
		echo "$cf"
	fi
}

volume() {
	level=$(vol level)
	state=$(vol state)
	if [ "$state" = "on" ]; then
		printf '%03d' "$level"
	else
		printf '%s' " ⮝ "
	fi
}

song() {
	cur=$(mpc current)
	if [ -n "$cfur" ]; then
		echo "$cfur"
	else
		echo "empty"
	fi
}

desktop() {
	desktop_name=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')

	case "$desktop_name" in
		0) printf '%s\n' "$cf⮫$ef ⮬ ⮭ ⮮ ⮯";;
		1) printf '%s\n' "⮫ $cf⮬$ef ⮭ ⮮ ⮯";;
		2) printf '%s\n' "⮫ ⮬ $cf⮭$ef ⮮ ⮯";;
		3) printf '%s\n' "⮫ ⮬ ⮭ $cf⮮$ef ⮯";;
		4) printf '%s\n' "⮫ ⮬ ⮭ ⮮ $cf⮯$ef";;
	esac
}

#playstate() {
#	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)
#
#	if [ "$status" = "[playing]" ]; then
#		printf '⮔'
#	else
#		printf '⮓'
#	fi
#}

playstate() {
	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)

	if [ "$status" = "[playing]" ]; then
		echo "$cf"
	else
		echo ""
	fi
}

playperc() {
	status=$(mpc status | sed '2!d' | mawk '{ print $3 }' | tr ':/' ' ' | mawk '{ print $1*60+$2" "$3*60+$4 }')

	pos=$(echo "$status" | mawk '{ print $1 }')
	len=$(echo "$status" | mawk '{ print $2 }')

	clen=1
	s=' ▁▂▃▄▅▆▇█'
	#s='    █   ██  ███ ████'


	if [ -z $pos ]; then
		printf "${s:0:$cflen}"
	else
		perc=$(( 1 + pos * (${#s} / clen - 1)  / (len + 1) ))

		#perc=$(( pos * ${#s} / (len + 1) ))

		printf "${s:$(( perc * clen )):$cflen}"
	fi
}



handle() {
	while read data; do
		case "$data" in
			ci) count_up;;
			cr) settmp inf_count 0;;
			+*|-*) tea_add "$data";;
			=*) settmp tea_time "$(echo $data | cut -c2-)";;
			tea_run) tt "$(gettmp tea_time)s";;
			*) echo "$data" | sh >/dev/null;;
		esac
	done
}

tea_add() {
	if [ $(($(gettmp tea_time) + $1)) -lt 0 ]; then
		settmp tea_time 0;
	else
		settmp tea_time $(($(gettmp tea_time) + $1));
	fi
}

count_up() {
	if [ $(gettmp inf_count) -lt 25 ]; then
		settmp inf_count $(($(gettmp inf_count) + 1));
	fi
}

tea_gettime () {
	printf "%3ds" "$(gettmp tea_time)"
}

count() {
	c=$1

	while [ $c -ge 5 ]; do
		printf 'bbbb';
		c=$((c - 5))
		if [ $c -gt 0 ]; then
			printf ' ';
		fi
	done

	while [ $c -gt 0 ]; do
		printf 'a';
		c=$((c - 1))
	done
}

inf_count () {
	# u suck printf (or im stupid)
	printf "%-24s" "$(count $(gettmp inf_count))" | sed 's/a/│/g' | sed 's/b/┼/g'
}

settmp tea_time 0
settmp inf_count 0
trap 'rmtmp tea_time; rmtmp inf_count' SIGINT SIGTERM

while :; do
	buf=""
	buf="${buf}%{A:tea_run:} $(tea)⮖$ef $(clock)%{A}"
	buf="${buf}%{O370}$cf%{A:-15:}▼ %{A}%{A:-5:}▽ %{A}$ef%{A:+60:}%{A3:=0:}$(tea_gettime)%{A}%{A}$cf%{A:+5:} △%{A}%{A:+15:} ▲%{A}$ef"
	buf="${buf}%{c}$(desktop)"
	buf="${buf}%{r}%{A:ci:}%{A3:cr:}$cf│$ef $(inf_count) $cf│$ef%{A}%{A}%{O330}"
	buf="${buf}$cf⮕$ef"
	buf="${buf} $(song)"
	buf="${buf}$cf%{A:mpc prev:} ⮳%{A}%{A:mpc toggle:} $ef$(playstate)$(playperc) %{A}$cf%{A:mpc next:}⮲ %{A}$ef"
	buf="${buf} $cf%{A:vol -:} ⮟ %{A}$ef%{A:vol !:} $(volume) %{A}$cf%{A:vol +:} ⮞ %{A}$ef"
	echo " $buf"
	sleep .01
done | bar | handle

#buf="${buf} $cf%{A:mpc toggle:}$(playstate) %{A}%{A:mpc prev:}⮳%{A} $(playperc) %{A:mpc next:}⮲ %{A}$ef"
#buf="${buf} %{F#a54242}%{A:vol -:} - %{A}%{F-} $(volume) %{F#21a11d}%{A:vol +:} + %{A}%{F-}"
#buf="${buf}  %{+u}%{B#a54242}%{A:ciao:} ⯉ %{A}%{B-}%{-u}"
