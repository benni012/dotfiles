#!/bin/sh

c="%{F$(xrq *color8)}"
e="%{F-}"

settmp tea_time 10

clock() {
	date "+%d.%m.%Y %H:%M:%S"
}

tea() {
	if [ $(pgrep -x tt | wc -l) -ge 1 -o $(atq | wc -l) -ge 1 ]; then
		echo "%{F$(xrq *color14)}"
	else
		echo "$c"
	fi
}

volume() {
	level=$(vol level)
	state=$(vol state)
	if [ "$state" = "on" ]; then
		printf '%03d' "$level"
	else
		printf '%s' " ⮝ "
	fi
}

song() {
	cur=$(mpc current)
	if [ -n "$cur" ]; then
		echo "$cur"
	else
		echo "empty"
	fi
}

desktop() {
	desktop_name=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')

	case "$desktop_name" in
		0) printf '%s\n' "$c⮫$e ⮬ ⮭ ⮮ ⮯";;
		1) printf '%s\n' "⮫ $c⮬$e ⮭ ⮮ ⮯";;
		2) printf '%s\n' "⮫ ⮬ $c⮭$e ⮮ ⮯";;
		3) printf '%s\n' "⮫ ⮬ ⮭ $c⮮$e ⮯";;
		4) printf '%s\n' "⮫ ⮬ ⮭ ⮮ $c⮯$e";;
	esac
}

#playstate() {
#	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)
#
#	if [ "$status" = "[playing]" ]; then
#		printf '⮔'
#	else
#		printf '⮓'
#	fi
#}

playstate() {
	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)

	if [ "$status" = "[playing]" ]; then
		echo "$c"
	else
		echo ""
	fi
}

playperc() {
	status=$(mpc status | sed '2!d' | mawk '{ print $3 }' | tr ':/' ' ' | mawk '{ print $1*60+$2" "$3*60+$4 }')

	pos=$(echo "$status" | mawk '{ print $1 }')
	len=$(echo "$status" | mawk '{ print $2 }')

	clen=1
	s=' ▁▂▃▄▅▆▇█'
	#s='    █   ██  ███ ████'


	if [ -z $pos ]; then
		printf "${s:0:$clen}"
	else
		perc=$(( 1 + pos * (${#s} / clen - 1)  / (len + 1) ))

		#perc=$(( pos * ${#s} / (len + 1) ))

		printf "${s:$(( perc * clen )):$clen}"
	fi
}



handle() {
	while read data; do
		case "$data" in
			+*|-*) tea_add "$data";;
			=*) settmp tea_time "$(echo $data | cut -c2-)";;
			tea_run) tt "$(gettmp tea_time)s";;
			*) echo "$data" | sh >/dev/null;;
		esac
	done
}

tea_add() {
	if [ $(($(gettmp tea_time) + $1)) -lt 0 ]; then
		settmp tea_time 0;
	else
		settmp tea_time $(($(gettmp tea_time) + $1));
	fi
}

tea_gettime () {
	printf "%3ds" "$(gettmp tea_time)"
}

while :; do
	buf=""
	buf="${buf}%{A:tea_run:} $(tea)⮖$e $(clock)%{A}                                                                     $c%{A:-15:}▼ %{A}%{A:-5:}▽ %{A}$e%{A:=10:}$(tea_gettime)%{A}$c%{A:+5:} △%{A}%{A:+15:} ▲%{A}$e"
	buf="${buf} %{c}$(desktop)"
	buf="${buf} %{r}$c⮕$e"
	buf="${buf} $(song)"
	buf="${buf}$c%{A:mpc prev:} ⮳%{A}%{A:mpc toggle:} $e$(playstate)$(playperc) %{A}$c%{A:mpc next:}⮲ %{A}$e"
	buf="${buf} $c%{A:vol -:} ⮟ %{A}$e%{A:vol !:} $(volume) %{A}$c%{A:vol +:} ⮞ %{A}$e"
	echo " $buf"
	sleep .01
done | bar | handle

rmtmp tea_time

#buf="${buf} $c%{A:mpc toggle:}$(playstate) %{A}%{A:mpc prev:}⮳%{A} $(playperc) %{A:mpc next:}⮲ %{A}$e"
#buf="${buf} %{F#a54242}%{A:vol -:} - %{A}%{F-} $(volume) %{F#21a11d}%{A:vol +:} + %{A}%{F-}"
#buf="${buf}  %{+u}%{B#a54242}%{A:ciao:} ⯉ %{A}%{B-}%{-u}"
