#!/bin/sh

c="%{F$(xrq *color5)}"
e="%{F-}"

clock() {
	date "+%d.%m.%Y %H:%M:%S"
}

tea() {
	if [ $(pgrep -x tt | wc -l) -ge 1 ]; then
		echo "%{F$(xrq *color1)}"
	else
		echo "$c"
	fi
}

volume() {
	level=$(vol level)
	state=$(vol state)
	if [ "$state" = "on" ]; then
		printf '%03d' "$level"
	else
		printf '%s' " ⮝ "
	fi
}

song() {
	cur=$(mpc current)
	if [ -n "$cur" ]; then
		echo "$cur"
	else
		echo "empty"
	fi
}

desktop() {
	desktop_name=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')

	case "$desktop_name" in
		0) printf '%s\n' "$c⮫$e ⮬ ⮭ ⮮ ⮯";;
		1) printf '%s\n' "⮫ $c⮬$e ⮭ ⮮ ⮯";;
		2) printf '%s\n' "⮫ ⮬ $c⮭$e ⮮ ⮯";;
		3) printf '%s\n' "⮫ ⮬ ⮭ $c⮮$e ⮯";;
		4) printf '%s\n' "⮫ ⮬ ⮭ ⮮ $c⮯$e";;
	esac
}

#playstate() {
#	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)
#
#	if [ "$status" = "[playing]" ]; then
#		printf '⮔'
#	else
#		printf '⮓'
#	fi
#}

playstate() {
	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)

	if [ "$status" = "[playing]" ]; then
		echo "$c"
	else
		echo ""
	fi
}

playperc() {
	status=$(mpc | sed '2!d' | mawk '{ print $3 }' | tr ':/' ' ' | mawk '{ print $1*60+$2" "$3*60+$4 }')

	pos=$(echo "$status" | mawk '{ print $1 }')
	len=$(echo "$status" | mawk '{ print $2 }')

	clen=1
	s=' ▁▂▃▄▅▆▇█'
	#s='    █   ██  ███ ████'


	if [ -z $pos ]; then
		printf "${s:0:$clen}"
	else
		perc=$(( 1 + pos * (${#s} / clen - 1)  / (len + 1) ))

		#perc=$(( pos * ${#s} / (len + 1) ))

		printf "${s:$(( perc * clen )):$clen}"
	fi
}

while :; do
	buf=""
	buf="${buf} $(tea)⮖$e $(clock)"
	buf="${buf} %{c}$(desktop)"
	buf="${buf} %{r}$c⮕$e"
	buf="${buf} $(song)"
	buf="${buf}$c%{A:mpc prev:} ⮳%{A}%{A:mpc toggle:} $e$(playstate)$(playperc) %{A}$c%{A:mpc next:}⮲ %{A}$e"
	buf="${buf} $c%{A:vol -:} ⮟ %{A}$e%{A:vol !:} $(volume) %{A}$c%{A:vol +:} ⮞ %{A}$e"
	echo " $buf"
	sleep .01
done | bar | sh >/dev/null

#buf="${buf} $c%{A:mpc toggle:}$(playstate) %{A}%{A:mpc prev:}⮳%{A} $(playperc) %{A:mpc next:}⮲ %{A}$e"
#buf="${buf} %{F#a54242}%{A:vol -:} - %{A}%{F-} $(volume) %{F#21a11d}%{A:vol +:} + %{A}%{F-}"
#buf="${buf}  %{+u}%{B#a54242}%{A:ciao:} ⯉ %{A}%{B-}%{-u}"
