#!/bin/mksh

#c="%{F#508050}"
c="%{F#70a070}"
#c="%{F#81a2be}"

e="%{F-}"

clock() {
	date "+%d.%m.%Y %H:%M:%S"
}

volume() {
	level=$(vol level | tr --delete '%')
	state=$(vol state)
	if [ $state = "on" ]; then
		printf '%03d' "$level"
	else
		printf '%s' " ⮝ "
	fi
}

song() {
	cur=$(mpc current)
	if [ -n "$cur" ]; then
		echo "$cur"
	else
		echo "empty"
	fi
}

lsong() {
	if [ -f "/tmp/lastsong" ]; then
		echo "%{F#b06a58}"
	else
		echo "$c"
	fi
}

desktop() {
	desktop_name=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')

	case "$desktop_name" in
		0) printf '%s\n' "$c⮫$e ⮬ ⮭ ⮮ ⮯";;
		1) printf '%s\n' "⮫ $c⮬$e ⮭ ⮮ ⮯";;
		2) printf '%s\n' "⮫ ⮬ $c⮭$e ⮮ ⮯";;
		3) printf '%s\n' "⮫ ⮬ ⮭ $c⮮$e ⮯";;
		4) printf '%s\n' "⮫ ⮬ ⮭ ⮮ $c⮯$e";;
	esac
}

playstate() {
	status=$(mpc status | grep "\[" | awk '{print $1}' | tail -1)

	if [ "$status" = "[playing]" ]; then
		printf '⮔'
	else
		printf '⮓'
	fi
}

while :; do
	buf=""
	buf="${buf} $c⮖$e $(clock)"
	buf="${buf} %{c}$(desktop)"
	buf="${buf} %{r}$(lsong)⮕$e"
	buf="${buf} $(song)"
	buf="${buf} $c%{A:mpc toggle:} $(playstate) %{A}%{A:mpc prev:}⮳%{A} %{A:mpc next:}⮲ %{A}$e"
	buf="${buf} $c%{A:vol -:} ⮟ %{A}$e%{A:vol !:} $(volume) %{A}$c%{A:vol +:} ⮞ %{A}$e"
	echo " $buf"
done | bar

#buf="${buf} %{F#a54242}%{A:vol -:} - %{A}%{F-} $(volume) %{F#21a11d}%{A:vol +:} + %{A}%{F-}"
#buf="${buf}  %{+u}%{B#a54242}%{A:ciao:} ⯉ %{A}%{B-}%{-u}"
